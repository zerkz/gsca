name: Test Flatpak Build

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build flatpak for'
        required: true
        default: 'v1.0.0'

jobs:
  flatpak:
    name: Build Flatpak
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/flathub-infra/flatpak-github-actions:freedesktop-24.08
      options: --privileged

    steps:
    - name: Set version
      id: get_version
      run: |
        TAG="${{ github.event.inputs.tag }}"
        echo "TAG=$TAG" >> $GITHUB_OUTPUT
        echo "VERSION=${TAG#v}" >> $GITHUB_OUTPUT

    - name: Download Linux binary from release
      run: |
        # First get release info with JSON accept header
        curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github+json" \
          "https://api.github.com/repos/zerkz/gsca/releases/tags/${{ steps.get_version.outputs.TAG }}" \
          -o release.json
        cat release.json | head -100
        ASSET_URL=$(cat release.json | python3 -c "import sys,json; assets=json.load(sys.stdin).get('assets',[]); print(next((a['url'] for a in assets if 'linux_amd64.tar.gz' in a['name']), ''))")
        echo "Asset URL: $ASSET_URL"
        # Then download the asset with octet-stream accept header
        curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/octet-stream" \
          "$ASSET_URL" -o gsca.tar.gz
        tar xzf gsca.tar.gz
        chmod +x gsca
        ls -la gsca

    - name: Checkout for manifest
      uses: actions/checkout@v4
      with:
        sparse-checkout: .github/flatpak-manifest.yaml
        sparse-checkout-cone-mode: false

    - name: Build Flatpak bundle
      run: |
        cp .github/flatpak-manifest.yaml ./
        cat flatpak-manifest.yaml
        flatpak-builder --user --force-clean --disable-rofiles-fuse --repo=repo build-dir flatpak-manifest.yaml
        flatpak build-bundle repo gsca-${{ steps.get_version.outputs.TAG }}.flatpak com.github.zerkz.gsca
        ls -la *.flatpak
